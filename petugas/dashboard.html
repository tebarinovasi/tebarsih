<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petugas Dashboard - TBS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        #map {
            height: 300px;
            width: 100%;
            border-radius: 0.5rem;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-indigo-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="../assets/tbs-logo.png" alt="TBS Logo" class="h-10">
                <h1 class="text-2xl font-bold">Petugas Dashboard</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="userName" class="font-medium">Petugas Name</span>
                <button id="logoutBtn" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-indigo-100 transition">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 mt-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Attendance Status -->
            <div class="col-span-1 bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Status Absensi</h2>
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600">Status:</span>
                        <span id="statusText" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600">Jam Masuk:</span>
                        <span id="checkInTime" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Jam Keluar:</span>
                        <span id="checkOutTime" class="font-semibold">-</span>
                    </div>
                </div>
                
                <div class="flex flex-col space-y-4">
                    <button id="activateGpsBtn" class="w-full py-3 px-4 bg-yellow-500 text-white rounded-md font-medium flex justify-center items-center hover:bg-yellow-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Aktifkan GPS
                    </button>
                    
                    <button id="checkInBtn" disabled class="w-full py-3 px-4 bg-green-500 text-white rounded-md font-medium flex justify-center items-center hover:bg-green-600 transition cursor-not-allowed opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                        </svg>
                        Absen Masuk
                    </button>
                    
                    <button id="checkOutBtn" disabled class="w-full py-3 px-4 bg-red-500 text-white rounded-md font-medium flex justify-center items-center hover:bg-red-600 transition cursor-not-allowed opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        Absen Keluar
                    </button>
                </div>
            </div>
            
            <!-- Middle Column - GPS Location -->
            <div class="col-span-1 bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Lokasi GPS</h2>
                <div id="gpsStatus" class="mb-4 p-3 bg-red-50 text-red-700 rounded-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <span>GPS tidak aktif</span>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600">Latitude:</span>
                        <span id="latitudeValue" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Longitude:</span>
                        <span id="longitudeValue" class="font-semibold">-</span>
                    </div>
                </div>
                
                <div id="map"></div>
            </div>
            
            <!-- Right Column - Documentation Upload -->
            <div class="col-span-1 bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Dokumentasi</h2>
                
                <div class="mb-4">
                    <label for="documentationType" class="block text-sm font-medium text-gray-700 mb-2">Jenis Dokumentasi</label>
                    <select id="documentationType" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Pilih jenis dokumentasi</option>
                        <option value="location">Lokasi Kerja</option>
                        <option value="activity">Aktivitas Kerja</option>
                        <option value="report">Laporan</option>
                        <option value="other">Lainnya</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="photoDescription" class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                    <textarea id="photoDescription" rows="3" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Unggah Foto</label>
                    <div class="flex items-center justify-center w-full">
                        <label for="photoUpload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-8 h-8 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Klik untuk unggah</span></p>
                                <p class="text-xs text-gray-500">PNG, JPG or JPEG (Maks. 5MB)</p>
                            </div>
                            <input id="photoUpload" type="file" accept="image/*" class="hidden" />
                        </label>
                    </div>
                </div>
                
                <div id="photoPreviewContainer" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
                    <div class="relative">
                        <img id="photoPreview" src="#" alt="Preview" class="w-full h-40 object-cover rounded-lg">
                        <button id="removePhotoBtn" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <button id="uploadDocBtn" class="w-full py-3 px-4 bg-indigo-500 text-white rounded-md font-medium flex justify-center items-center hover:bg-indigo-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
                    </svg>
                    Unggah Dokumentasi
                </button>
            </div>
        </div>
        
        <!-- Recent Activity Section -->
        <div class="mt-8 bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Aktivitas Terbaru</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Keluar</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durasi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi Masuk</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi Keluar</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dokumentasi</th>
                        </tr>
                    </thead>
                    <tbody id="activityTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Loading spinner -->
    <div id="loadingSpinner" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="spinner"></div>
    </div>

    <!-- Success popup -->
    <div id="successPopup" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl">
            <h3 class="text-2xl font-bold mb-4">Sukses!</h3>
            <p id="successMessage" class="mb-4"></p>
            <button onclick="closePopup()" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                Tutup
            </button>
        </div>
    </div>

<script>
        // Supabase configuration
        const supabaseUrl = 'https://telxfiwfgambvtokvvem.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRlbHhmaXdmZ2FtYnZ0b2t2dmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NzYwMTUsImV4cCI6MjA2MjI1MjAxNX0._Lrv33QGZk9qt27CqjXAdI7BfPbn5RYtyXxctFLcSUg';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Mapbox configuration
        mapboxgl.accessToken = 'pk.eyJ1IjoiaGtsZnJobnN5aCIsImEiOiJjbWFkajdobTEwZWt6MnBzaXB1ajQ1cnd3In0.SNQYcxrFSahI0aKUhyZIQA';
        
        // Global variables
        let map;
        let marker;
        let watchId = null;
        let currentUser = null;
        let userAttendance = null;
        let isGpsActive = false;
        let currentPosition = null;
        let uploadedPhotoFile = null;
        let attendanceSubscription = null;
        let gpsUpdateInterval = null;
        
        // DOM Elements
        const activateGpsBtn = document.getElementById('activateGpsBtn');
        const checkInBtn = document.getElementById('checkInBtn');
        const checkOutBtn = document.getElementById('checkOutBtn');
        const gpsStatus = document.getElementById('gpsStatus');
        const latitudeValue = document.getElementById('latitudeValue');
        const longitudeValue = document.getElementById('longitudeValue');
        const statusText = document.getElementById('statusText');
        const checkInTime = document.getElementById('checkInTime');
        const checkOutTime = document.getElementById('checkOutTime');
        const photoUpload = document.getElementById('photoUpload');
        const photoPreview = document.getElementById('photoPreview');
        const photoPreviewContainer = document.getElementById('photoPreviewContainer');
        const removePhotoBtn = document.getElementById('removePhotoBtn');
        const uploadDocBtn = document.getElementById('uploadDocBtn');
        const activityTableBody = document.getElementById('activityTableBody');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading();
            
            // Check if user is logged in
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (error || !session) {
                hideLoading();
                alert('Session expired. Please login again.');
                window.location.href = '../index.html';
                return;
            }
            
            currentUser = session.user;
            userName.textContent = currentUser.email;
            
            // Initialize map
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [106.8456, -6.2088], // Jakarta coordinates
                zoom: 12
            });
            
            // Load today's attendance data
            await loadTodayAttendance();
            
            // Load activity history
            await loadActivityHistory();
            
            // Set up realtime subscription for attendance updates
            setupRealtimeSubscription();
            
            hideLoading();
            
            // Event listeners
            activateGpsBtn.addEventListener('click', toggleGPS);
            checkInBtn.addEventListener('click', checkIn);
            checkOutBtn.addEventListener('click', checkOut);
            photoUpload.addEventListener('change', handlePhotoUpload);
            removePhotoBtn.addEventListener('click', removePhoto);
            uploadDocBtn.addEventListener('click', uploadDocumentation);
            logoutBtn.addEventListener('click', logout);
        });

        // Setup realtime subscription for attendance updates
// Setup realtime subscription for attendance updates
function setupRealtimeSubscription() {
    if (attendanceSubscription) {
        supabaseClient.removeSubscription(attendanceSubscription);
    }
    
    attendanceSubscription = supabaseClient
        .channel('attendance-updates')
        .on('postgres_changes', 
            { event: '*', schema: 'public', table: 'attendance' },
            (payload) => {
                // Only update if it's the current user's attendance
                if (payload.new && payload.new.user_id === currentUser.id) {
                    loadTodayAttendance();
                }
            }
        )
        .subscribe();
}
        

        // Load today's attendance data
        async function loadTodayAttendance() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabaseClient
                    .from('attendance')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('check_in_time', today)
                    .lte('check_in_time', today + 'T23:59:59')
                    .maybeSingle();
                
                if (error) throw error;
                
                userAttendance = data;
                updateAttendanceUI();
            } catch (error) {
                console.error('Error loading attendance:', error);
            }
        }

        // Load activity history (last 7 days)
        async function loadActivityHistory() {
            try {
                const pastWeek = new Date();
                pastWeek.setDate(pastWeek.getDate() - 7);
                
                const { data, error } = await supabaseClient
                    .from('attendance')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('check_in_time', pastWeek.toISOString())
                    .order('check_in_time', { ascending: false });
                
                if (error) throw error;
                
                updateActivityTable(data);
            } catch (error) {
                console.error('Error loading activity history:', error);
            }
        }

        // Update activity table
        function updateActivityTable(activities) {
            activityTableBody.innerHTML = '';
            
            if (!activities || activities.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">Belum ada aktivitas terbaru</td>
                `;
                activityTableBody.appendChild(row);
                return;
            }
            
            activities.forEach(activity => {
                const checkInDate = new Date(activity.check_in_time);
                const checkOutDate = activity.check_out_time ? new Date(activity.check_out_time) : null;
                
                let duration = '-';
                if (checkOutDate) {
                    const durationMs = checkOutDate - checkInDate;
                    const durationHours = Math.floor(durationMs / (1000 * 60 * 60));
                    const durationMinutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                    duration = `${durationHours}h ${durationMinutes}m`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(checkInDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatTime(checkInDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${checkOutDate ? formatTime(checkOutDate) : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${duration}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${activity.check_in_location || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${activity.check_out_location || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${activity.documentation_url ? 
                        `<a href="${activity.documentation_url}" target="_blank" class="text-indigo-600 hover:text-indigo-900">Lihat</a>` : 
                        '-'}
                    </td>
                `;
                activityTableBody.appendChild(row);
            });
        }

        // Update attendance UI based on current state
        function updateAttendanceUI() {
            if (!userAttendance) {
                statusText.textContent = 'Belum Absen';
                statusText.className = 'font-semibold text-gray-500';
                checkInTime.textContent = '-';
                checkOutTime.textContent = '-';
                
                checkInBtn.disabled = !isGpsActive;
                checkOutBtn.disabled = true;
                
                if (isGpsActive) {
                    checkInBtn.classList.remove('cursor-not-allowed', 'opacity-50');
                } else {
                    checkInBtn.classList.add('cursor-not-allowed', 'opacity-50');
                }
                checkOutBtn.classList.add('cursor-not-allowed', 'opacity-50');
                
                return;
            }
            
            const checkInDate = new Date(userAttendance.check_in_time);
            checkInTime.textContent = formatDateTime(checkInDate);
            
            if (userAttendance.check_out_time) {
                // Already checked out
                statusText.textContent = 'Selesai';
                statusText.className = 'font-semibold text-gray-500';
                
                const checkOutDate = new Date(userAttendance.check_out_time);
                checkOutTime.textContent = formatDateTime(checkOutDate);
                
                checkInBtn.disabled = true;
                checkOutBtn.disabled = true;
                checkInBtn.classList.add('cursor-not-allowed', 'opacity-50');
                checkOutBtn.classList.add('cursor-not-allowed', 'opacity-50');
            } else {
                // Checked in but not checked out
                statusText.textContent = 'Sedang Bertugas';
                statusText.className = 'font-semibold text-green-500';
                checkOutTime.textContent = '-';
                
                // Check if 8 hours have passed since check-in
                const now = new Date();
                const eightHoursLater = new Date(checkInDate.getTime() + 8 * 60 * 60 * 1000);
                const canCheckOut = now >= eightHoursLater;
                
                checkInBtn.disabled = true;
                checkOutBtn.disabled = !isGpsActive || !canCheckOut;
                
                checkInBtn.classList.add('cursor-not-allowed', 'opacity-50');
                
                if (isGpsActive && canCheckOut) {
                    checkOutBtn.classList.remove('cursor-not-allowed', 'opacity-50');
                } else {
                    checkOutBtn.classList.add('cursor-not-allowed', 'opacity-50');
                    
                    if (!canCheckOut) {
                        const remainingTime = formatRemainingTime(eightHoursLater);
                        checkOutBtn.title = `Anda dapat absen keluar dalam ${remainingTime}`;
                    }
                }
            }
        }

        // Toggle GPS functionality
        async function toggleGPS() {
            if (isGpsActive) {
                deactivateGPS();
                return;
            }
            
            try {
                if (!navigator.geolocation) {
                    throw new Error('Geolocation tidak didukung oleh browser Anda.');
                }
                
                showLoading();
                
                // Request permission and get current position
                const position = await getCurrentPosition();
                currentPosition = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                
                // Update UI
                updateGpsUI(true);
                updateLocationDisplay(currentPosition);
                
                // Create or update marker on map
                if (!marker) {
                    marker = new mapboxgl.Marker({ color: '#3B82F6' })
                        .setLngLat([currentPosition.longitude, currentPosition.latitude])
                        .addTo(map);
                } else {
                    marker.setLngLat([currentPosition.longitude, currentPosition.latitude]);
                }
                
                // Center map on current position
                map.flyTo({
                    center: [currentPosition.longitude, currentPosition.latitude],
                    zoom: 15
                });
                
                // Set up continuous tracking
                watchId = navigator.geolocation.watchPosition(
                    handlePositionUpdate,
                    handleGeolocationError,
                    { enableHighAccuracy: true }
                );
                
                // Set up interval to update GPS position in Supabase
                gpsUpdateInterval = setInterval(updateGpsPositionInDatabase, 30000); // Every 30 seconds
                
                // Update initial position in database
                await updateGpsPositionInDatabase();
                
                // Update attendance button states
                updateAttendanceUI();
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(`Error activating GPS: ${error.message}`);
                console.error('GPS activation error:', error);
            }
        }

        // Deactivate GPS
        function deactivateGPS() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            if (gpsUpdateInterval) {
                clearInterval(gpsUpdateInterval);
                gpsUpdateInterval = null;
            }
            
            currentPosition = null;
            updateGpsUI(false);
            updateAttendanceUI();
        }

        // Handle position update
        function handlePositionUpdate(position) {
            currentPosition = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
            };
            
            updateLocationDisplay(currentPosition);
            
            if (marker) {
                marker.setLngLat([currentPosition.longitude, currentPosition.latitude]);
            }
        }

        // Handle geolocation errors
        function handleGeolocationError(error) {
            console.error('Geolocation error:', error);
            
            let errorMessage = 'Error accessing location';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'Akses lokasi ditolak oleh pengguna.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Informasi lokasi tidak tersedia.';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'Permintaan lokasi timeout.';
                    break;
                case error.UNKNOWN_ERROR:
                    errorMessage = 'Terjadi kesalahan saat mengakses lokasi.';
                    break;
            }
            
            alert(errorMessage);
            deactivateGPS();
        }

        // Get current position as a Promise
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
        }

        // Update GPS UI
        function updateGpsUI(isActive) {
            isGpsActive = isActive;
            
            if (isActive) {
                activateGpsBtn.textContent = 'GPS Aktif - Nonaktifkan';
                activateGpsBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                activateGpsBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                
                gpsStatus.classList.remove('bg-red-50', 'text-red-700');
                gpsStatus.classList.add('bg-green-50', 'text-green-700');
                gpsStatus.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>GPS aktif</span>
                `;
            } else {
                activateGpsBtn.textContent = 'Aktifkan GPS';
                activateGpsBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                activateGpsBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                
                gpsStatus.classList.remove('bg-green-50', 'text-green-700');
                gpsStatus.classList.add('bg-red-50', 'text-red-700');
                gpsStatus.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <span>GPS tidak aktif</span>
                `;
                
                latitudeValue.textContent = '-';
                longitudeValue.textContent = '-';
            }
        }

        // Update location display
        function updateLocationDisplay(position) {
            if (position) {
                latitudeValue.textContent = position.latitude.toFixed(6);
                longitudeValue.textContent = position.longitude.toFixed(6);
            } else {
                latitudeValue.textContent = '-';
                longitudeValue.textContent = '-';
            }
        }

        // Update GPS position in database
        async function updateGpsPositionInDatabase() {
            if (!currentPosition || !currentUser) return;
            
            try {
                const { error } = await supabaseClient
                    .from('gps_logs')
                    .insert({
                        user_id: currentUser.id,
                        latitude: currentPosition.latitude,
                        longitude: currentPosition.longitude,
                        timestamp: new Date().toISOString()
                    });
                
                if (error) throw error;
            } catch (error) {
                console.error('Error updating GPS position:', error);
            }
        }

        // Check in functionality
        async function checkIn() {
            if (!isGpsActive || !currentPosition) {
                alert('Aktifkan GPS terlebih dahulu!');
                return;
            }
            
            showLoading();
            
            try {
                // Get location name using reverse geocoding
                const locationName = await getLocationName(currentPosition.latitude, currentPosition.longitude);
                
                // Create new attendance record
                const { data, error } = await supabaseClient
                    .from('attendance')
                    .insert({
                        user_id: currentUser.id,
                        check_in_time: new Date().toISOString(),
                        check_in_latitude: currentPosition.latitude,
                        check_in_longitude: currentPosition.longitude,
                        check_in_location: locationName
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                userAttendance = data;
                updateAttendanceUI();
                
                hideLoading();
                showSuccessPopup('Absen masuk berhasil!');
            } catch (error) {
                hideLoading();
                alert(`Error saat absen masuk: ${error.message}`);
                console.error('Check-in error:', error);
            }
        }

        // Check out functionality
        async function checkOut() {
            if (!isGpsActive || !currentPosition) {
                alert('Aktifkan GPS terlebih dahulu!');
                return;
            }
            
            if (!userAttendance || userAttendance.check_out_time) {
                alert('Tidak dapat absen keluar. Anda belum absen masuk atau sudah absen keluar!');
                return;
            }
            
            // Check if 8 hours have passed since check-in
            const checkInDate = new Date(userAttendance.check_in_time);
            const now = new Date();
            const eightHoursLater = new Date(checkInDate.getTime() + 8 * 60 * 60 * 1000);
            
            if (now < eightHoursLater) {
                const remainingTime = formatRemainingTime(eightHoursLater);
                alert(`Anda belum dapat absen keluar. Minimal waktu kerja adalah 8 jam. Silakan coba lagi dalam ${remainingTime}.`);
                return;
            }
            
            showLoading();
            
            try {
                // Get location name using reverse geocoding
                const locationName = await getLocationName(currentPosition.latitude, currentPosition.longitude);
                
                // Update attendance record with check-out information
                const { data, error } = await supabaseClient
                    .from('attendance')
                    .update({
                        check_out_time: new Date().toISOString(),
                        check_out_latitude: currentPosition.latitude,
                        check_out_longitude: currentPosition.longitude,
                        check_out_location: locationName
                    })
                    .eq('id', userAttendance.id)
                    .select()
                    .single();
                
                if (error) throw error;
                
                userAttendance = data;
                updateAttendanceUI();
                
                // Reload activity history
                await loadActivityHistory();
                
                hideLoading();
                showSuccessPopup('Absen keluar berhasil!');
            } catch (error) {
                hideLoading();
                alert(`Error saat absen keluar: ${error.message}`);
                console.error('Check-out error:', error);
            }
        }

        // Get location name from coordinates using reverse geocoding
        async function getLocationName(latitude, longitude) {
            try {
                const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${longitude},${latitude}.json?access_token=${mapboxgl.accessToken}`);
                const data = await response.json();
                
                if (data && data.features && data.features.length > 0) {
                    return data.features[0].place_name;
                }
                
                return `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                return `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            }
        }

        // Handle photo upload
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file type
            const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
            if (!validTypes.includes(file.type)) {
                alert('Hanya file JPG, JPEG, atau PNG yang diizinkan!');
                photoUpload.value = '';
                return;
            }
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Ukuran file terlalu besar. Maksimal 5MB!');
                photoUpload.value = '';
                return;
            }
            
            // Create preview
            const reader = new FileReader();
            reader.onload = function(e) {
                photoPreview.src = e.target.result;
                photoPreviewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
            
            uploadedPhotoFile = file;
        }

        // Remove photo
        function removePhoto() {
            uploadedPhotoFile = null;
            photoUpload.value = '';
            photoPreviewContainer.classList.add('hidden');
        }

        // Upload documentation
        async function uploadDocumentation() {
            const documentationType = document.getElementById('documentationType').value;
            const photoDescription = document.getElementById('photoDescription').value;
            
            if (!documentationType) {
                alert('Pilih jenis dokumentasi!');
                return;
            }
            
            if (!photoDescription) {
                alert('Masukkan deskripsi foto!');
                return;
            }
            
            if (!uploadedPhotoFile) {
                alert('Unggah foto terlebih dahulu!');
                return;
            }
            
            showLoading();
            
            try {
                // Upload photo to storage
                const filename = `documentation/${currentUser.id}/${Date.now()}-${uploadedPhotoFile.name}`;
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('uploads')
                    .upload(filename, uploadedPhotoFile);
                
                if (uploadError) throw uploadError;
                
                // Get public URL
                const { data: publicUrlData } = supabaseClient.storage
                    .from('uploads')
                    .getPublicUrl(filename);
                
                const publicUrl = publicUrlData.publicUrl;
                
                // Save documentation to database
                const { error: docError } = await supabaseClient
                    .from('documentation')
                    .insert({
                        user_id: currentUser.id,
                        type: documentationType,
                        description: photoDescription,
                        image_url: publicUrl,
                        location_latitude: currentPosition ? currentPosition.latitude : null,
                        location_longitude: currentPosition ? currentPosition.longitude : null,
                        attendance_id: userAttendance ? userAttendance.id : null
                    });
                
                if (docError) throw docError;
                
                // Clear form
                document.getElementById('documentationType').value = '';
                document.getElementById('photoDescription').value = '';
                removePhoto();
                
                hideLoading();
                showSuccessPopup('Dokumentasi berhasil diunggah!');
            } catch (error) {
                hideLoading();
                alert(`Error saat mengunggah dokumentasi: ${error.message}`);
                console.error('Documentation upload error:', error);
            }
        }

        // Logout functionality
        async function logout() {
            showLoading();
            
            try {
                // Clean up subscriptions and intervals
                if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                }
                
                if (gpsUpdateInterval) {
                    clearInterval(gpsUpdateInterval);
                }
                
                if (attendanceSubscription) {
                    supabaseClient.removeSubscription(attendanceSubscription);
                }
                
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                window.location.href = '../index.html';
            } catch (error) {
                hideLoading();
                alert(`Error during logout: ${error.message}`);
                console.error('Logout error:', error);
            }
        }

        // Show loading spinner
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        // Hide loading spinner
        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        // Show success popup
        function showSuccessPopup(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successPopup').classList.remove('hidden');
        }

        // Close popup
        function closePopup() {
            document.getElementById('successPopup').classList.add('hidden');
        }

        // Format date
        function formatDate(date) {
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Format time
        function formatTime(date) {
            return date.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Format date and time
        function formatDateTime(date) {
            return `${formatDate(date)} ${formatTime(date)}`;
        }

        // Format remaining time
        function formatRemainingTime(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            
            if (diff <= 0) return '0 menit';
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            let result = '';
            if (hours > 0) result += `${hours} jam `;
            if (minutes > 0) result += `${minutes} menit`;
            
            return result.trim();
        }
    </script>
</body>
</html>