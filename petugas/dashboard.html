<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Petugas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Leaflet JS & CSS for Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #map { height: 250px; border-radius: 1rem; }
    .leaflet-control-attribution { display: none; }
    #preview-img { max-height: 120px; border-radius: 0.5rem; margin-top: 0.5rem; }
  </style>
</head>
<body class="bg-gradient-to-br from-[#0f172a] via-[#334155] to-[#1e293b] min-h-screen flex flex-col items-center justify-start py-8">

  <!-- Header -->
  <div class="w-full max-w-2xl bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-8 border border-white/20 mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-white mb-1" id="welcome-msg">Selamat datang, Petugas!</h1>
        <div class="flex items-center gap-2 text-white/80 text-sm">
          <span id="tanggal"></span>
          <span id="jam" class="ml-2 font-mono"></span>
        </div>
      </div>
      <div class="flex flex-col items-start md:items-end">
        <span class="text-white/80 text-sm mb-1">Status Absen Hari Ini:</span>
        <span id="status-absen" class="inline-block px-3 py-1 rounded-lg font-semibold bg-yellow-400/20 text-yellow-400">Memuat...</span>
      </div>
    </div>
  </div>

  <!-- Absensi Card -->
  <div class="w-full max-w-2xl bg-white/10 backdrop-blur-lg rounded-2xl shadow-xl p-8 border border-white/20 mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div>
        <div class="text-white/80 text-sm mb-1">Absen Masuk:</div>
        <div id="jam-masuk" class="text-lg font-mono text-white">-</div>
      </div>
      <div>
        <div class="text-white/80 text-sm mb-1">Absen Pulang:</div>
        <div id="jam-pulang" class="text-lg font-mono text-white">-</div>
      </div>
      <div>
        <div class="text-white/80 text-sm mb-1">Timer Pulang:</div>
        <div id="timer-pulang" class="text-lg font-mono text-blue-400">-</div>
      </div>
    </div>
    <div class="flex flex-col md:flex-row gap-4">
      <button id="btn-absen-masuk" class="flex-1 py-3 rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">Absen Masuk</button>
      <button id="btn-absen-pulang" class="flex-1 py-3 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-bold shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">Absen Pulang</button>
    </div>
  </div>

  <!-- GPS Card -->
  <div class="w-full max-w-2xl bg-white/10 backdrop-blur-lg rounded-2xl shadow-xl p-8 border border-white/20 mb-8">
    <div class="flex items-center gap-4 mb-4">
      <button id="btn-gps" class="py-2 px-6 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-bold shadow-lg transition-all disabled:opacity-70 disabled:cursor-not-allowed">Aktifkan GPS</button>
      <span id="gps-status" class="text-white/80 text-sm">GPS belum aktif</span>
    </div>
    <div id="map" class="w-full"></div>
  </div>

  <!-- Form Foto Dokumentasi -->
  <div class="w-full max-w-2xl bg-white/10 backdrop-blur-lg rounded-2xl shadow-xl p-8 border border-white/20 mb-8">
    <h2 class="text-white text-lg font-bold mb-4">Upload Foto Dokumentasi</h2>
    <form id="form-foto" class="space-y-4">
      <div>
        <label class="block text-white/80 mb-1 font-medium" for="deskripsi-foto">Deskripsi Foto</label>
        <select id="deskripsi-foto" class="w-full px-4 py-2 rounded-lg bg-white/20 text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
          <option value="">Pilih deskripsi</option>
          <option value="Sebelum Pekerjaan">Sebelum Pekerjaan</option>
          <option value="Proses Pengerjaan">Proses Pengerjaan</option>
          <option value="Setelah Pekerjaan">Setelah Pekerjaan</option>
          <option value="Dokumentasi Lainnya">Dokumentasi Lainnya</option>
        </select>
      </div>
      <div>
        <label class="block text-white/80 mb-1 font-medium" for="foto-dokumentasi">Foto Dokumentasi</label>
        <input id="foto-dokumentasi" type="file" accept="image/*" class="w-full text-white" />
        <img id="preview-img" src="" alt="Preview" class="hidden" />
      </div>
      <button type="submit" class="w-full py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg transition-all">Upload Foto</button>
      <div id="foto-error" class="text-red-400 text-sm mt-2 hidden"></div>
      <div id="foto-success" class="text-green-400 text-sm mt-2 hidden"></div>
    </form>
    <div id="last-foto" class="mt-4"></div>
  </div>

  <!-- Popup -->
  <div id="popup" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-xs text-center">
      <div id="popup-msg" class="text-slate-800 mb-4"></div>
      <button onclick="document.getElementById('popup').classList.add('hidden')" class="w-full py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold shadow transition-all">OK</button>
    </div>
  </div>

  <script>
    // === KONFIGURASI SUPABASE ===
    const SUPABASE_URL = "https://bwtwcribfhbhizlbktlo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3dHdjcmliZmhiaGl6bGJrdGxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNTQ3NDksImV4cCI6MjA2MTYzMDc0OX0.svH7YM8CORYoUfsE4YoovZMsoulWgr3xWT9X6qV39Mc";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Fungsi untuk sanitasi nama lengkap agar aman untuk path/file
    function sanitizeNama(nama) {
      return nama
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-') // hanya huruf, angka, ganti selain itu dengan '-'
        .replace(/^-+|-+$/g, '')     // hapus '-' di awal/akhir
        .replace(/-+/g, '-');        // ganti '--' jadi '-'
    }

    // === VARIABEL GLOBAL ===
    let user = null;
    let absensiHariIni = null;
    let gpsAktif = false;
    let map = null;
    let marker = null;
    let posisiSekarang = null;
    let timerInterval = null;

    // === UTILITY ===
    function showPopup(msg) {
      document.getElementById('popup-msg').textContent = msg;
      document.getElementById('popup').classList.remove('hidden');
    }

    function formatTanggal(date) {
      const hari = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
      const bulan = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
      return hari[date.getDay()] + ", " + date.getDate() + " " + bulan[date.getMonth()] + " " + date.getFullYear();
    }

    function formatJam(date) {
      return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function diffJam(date1, date2) {
      // date2 - date1 dalam jam (float)
      return (date2 - date1) / (1000 * 60 * 60);
    }

    function sisaJam8Jam(jamMasuk) {
      const masuk = new Date(jamMasuk);
      const now = new Date();
      const target = new Date(masuk.getTime() + 8 * 60 * 60 * 1000);
      let sisa = (target - now) / 1000; // detik
      if (sisa < 0) sisa = 0;
      const jam = Math.floor(sisa / 3600);
      const menit = Math.floor((sisa % 3600) / 60);
      const detik = Math.floor(sisa % 60);
      return `${jam.toString().padStart(2,'0')}:${menit.toString().padStart(2,'0')}:${detik.toString().padStart(2,'0')}`;
    }

    // === JAM REALTIME & TANGGAL ===
    function updateJamTanggal() {
      const now = new Date();
      document.getElementById('tanggal').textContent = formatTanggal(now);
      document.getElementById('jam').textContent = formatJam(now);
    }
    setInterval(updateJamTanggal, 1000);
    updateJamTanggal();

    // === CEK LOGIN & AMBIL DATA USER ===
    async function cekLogin() {
      // Menggunakan getSession agar session persist
      const { data, error } = await supabase.auth.getSession();
      if (!data.session) {
        window.location.href = "../index.html";
        return;
      }
      user = data.session.user;
      // Ambil nama lengkap dari tabel users
      const { data: userData } = await supabase.from('users').select('nama_lengkap').eq('id', user.id).single();
      document.getElementById('welcome-msg').textContent = `Selamat datang, ${userData && userData.nama_lengkap ? userData.nama_lengkap : 'Petugas'}!`;
    }

    // === CEK STATUS ABSEN HARI INI ===
    async function cekAbsenHariIni() {
      const today = new Date();
      const tanggal = today.toISOString().slice(0,10);
      const { data, error } = await supabase
        .from('absensi')
        .select('*')
        .eq('user_id', user.id)
        .eq('tanggal', tanggal)
        .single();
      absensiHariIni = data || null;
      updateStatusAbsen();
      tampilkanFotoDokumentasi();
    }

    function updateStatusAbsen() {
      const statusEl = document.getElementById('status-absen');
      const jamMasukEl = document.getElementById('jam-masuk');
      const jamPulangEl = document.getElementById('jam-pulang');
      const btnMasuk = document.getElementById('btn-absen-masuk');
      const btnPulang = document.getElementById('btn-absen-pulang');
      const timerPulang = document.getElementById('timer-pulang');

      if (!absensiHariIni) {
        statusEl.textContent = "Belum absen hari ini";
        statusEl.className = "inline-block px-3 py-1 rounded-lg font-semibold bg-yellow-400/20 text-yellow-400";
        jamMasukEl.textContent = "-";
        jamPulangEl.textContent = "-";
        btnMasuk.disabled = false;
        btnPulang.disabled = true;
        timerPulang.textContent = "-";
        if (timerInterval) clearInterval(timerInterval);
      } else {
        jamMasukEl.textContent = absensiHariIni.jam_masuk ? absensiHariIni.jam_masuk.slice(0,5) : "-";
        jamPulangEl.textContent = absensiHariIni.jam_pulang ? absensiHariIni.jam_pulang.slice(0,5) : "-";
        if (absensiHariIni.jam_masuk && !absensiHariIni.jam_pulang) {
          statusEl.textContent = "Sudah absen masuk";
          statusEl.className = "inline-block px-3 py-1 rounded-lg font-semibold bg-blue-400/20 text-blue-400";
          btnMasuk.disabled = true;
          // Cek apakah sudah 8 jam
          const masuk = new Date(absensiHariIni.tanggal + "T" + absensiHariIni.jam_masuk);
          const now = new Date();
          const diff = diffJam(masuk, now);
          if (diff >= 8) {
            btnPulang.disabled = false;
            timerPulang.textContent = "00:00:00";
            if (timerInterval) clearInterval(timerInterval);
          } else {
            btnPulang.disabled = true;
            // Timer mundur
            function updateTimer() {
              timerPulang.textContent = sisaJam8Jam(absensiHariIni.tanggal + "T" + absensiHariIni.jam_masuk);
            }
            updateTimer();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
          }
        } else if (absensiHariIni.jam_masuk && absensiHariIni.jam_pulang) {
          statusEl.textContent = "Sudah absen pulang";
          statusEl.className = "inline-block px-3 py-1 rounded-lg font-semibold bg-green-400/20 text-green-400";
          btnMasuk.disabled = true;
          btnPulang.disabled = true;
          timerPulang.textContent = "Selesai";
          if (timerInterval) clearInterval(timerInterval);
        }
      }
    }

    // === ABSEN MASUK ===
    document.getElementById('btn-absen-masuk').onclick = async function() {
      if (!gpsAktif || !posisiSekarang) {
        showPopup("Aktifkan GPS terlebih dahulu sebelum absen masuk!");
        return;
      }
      // Cek apakah sudah absen hari ini
      if (absensiHariIni) {
        showPopup("Anda sudah absen masuk hari ini.");
        return;
      }
      const now = new Date();
      const tanggal = now.toISOString().slice(0,10);
      const jam = now.toTimeString().slice(0,8);
      const lokasi = `${posisiSekarang.coords.latitude},${posisiSekarang.coords.longitude}`;
      // Simpan ke Supabase
      const { error } = await supabase.from('absensi').insert({
        user_id: user.id,
        tanggal,
        jam_masuk: jam,
        lokasi_masuk: lokasi
      });
      if (error) {
        if (error.code === '23505' || error.message.includes('duplicate key')) {
          showPopup("Anda sudah absen masuk hari ini.");
        } else {
          showPopup("Gagal absen masuk. Coba lagi.");
        }
      } else {
        await cekAbsenHariIni();
        showPopup("Absen masuk berhasil!");
      }
    };

    // === ABSEN PULANG ===
    document.getElementById('btn-absen-pulang').onclick = async function() {
      if (!absensiHariIni || !absensiHariIni.jam_masuk) return;
      const masuk = new Date(absensiHariIni.tanggal + "T" + absensiHariIni.jam_masuk);
      const now = new Date();
      const diff = diffJam(masuk, now);
      if (diff < 8) {
        showPopup("Anda belum dapat absen pulang sebelum 8 jam kerja!");
        return;
      }
      if (!gpsAktif || !posisiSekarang) {
        showPopup("Aktifkan GPS terlebih dahulu sebelum absen pulang!");
        return;
      }
      const jam = now.toTimeString().slice(0,8);
      const lokasi = `${posisiSekarang.coords.latitude},${posisiSekarang.coords.longitude}`;
      // Update ke Supabase
      const { error } = await supabase.from('absensi')
        .update({ jam_pulang: jam, lokasi_pulang: lokasi })
        .eq('user_id', user.id)
        .eq('tanggal', absensiHariIni.tanggal);
      if (error) {
        showPopup("Gagal absen pulang. Coba lagi.");
      } else {
        await cekAbsenHariIni();
        showPopup("Absen pulang berhasil!");
      }
    };

    // === GPS & MAP ===
    document.getElementById('btn-gps').onclick = function() {
      if (gpsAktif) return;
      gpsAktif = true;
      this.disabled = true;
      this.textContent = "GPS Aktif";
      document.getElementById('gps-status').textContent = "GPS aktif, lokasi realtime ditampilkan.";
      // Mulai tracking lokasi
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(function(pos) {
          posisiSekarang = pos;
          // Inisialisasi map jika belum
          if (!map) {
            map = L.map('map').setView([pos.coords.latitude, pos.coords.longitude], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
            }).addTo(map);
            marker = L.marker([pos.coords.latitude, pos.coords.longitude]).addTo(map)
              .bindPopup("Lokasi Anda Sekarang").openPopup();
          } else {
            marker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
            map.setView([pos.coords.latitude, pos.coords.longitude]);
          }
        }, function(err) {
          showPopup("Gagal mengakses GPS: " + err.message);
        }, { enableHighAccuracy: true });
      } else {
        showPopup("Browser tidak mendukung GPS.");
      }
    };

    // === FOTO DOKUMENTASI ===
    // Preview foto
    document.getElementById('foto-dokumentasi').onchange = function(e) {
      const file = e.target.files[0];
      const preview = document.getElementById('preview-img');
      if (file) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          preview.src = ev.target.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = "";
        preview.classList.add('hidden');
      }
    };

    // Upload foto ke Supabase Storage dan simpan ke absensi
    document.getElementById('form-foto').onsubmit = async function(e) {
      e.preventDefault();
      const errorDiv = document.getElementById('foto-error');
      const successDiv = document.getElementById('foto-success');
      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');
      errorDiv.textContent = "";
      successDiv.textContent = "";

      if (!absensiHariIni) {
        errorDiv.textContent = "Anda harus absen masuk terlebih dahulu!";
        errorDiv.classList.remove('hidden');
        return;
      }

      const deskripsi = document.getElementById('deskripsi-foto').value;
      const fileInput = document.getElementById('foto-dokumentasi');
      const file = fileInput.files[0];

      if (!deskripsi) {
        errorDiv.textContent = "Pilih deskripsi foto terlebih dahulu!";
        errorDiv.classList.remove('hidden');
        return;
      }
      if (!file) {
        errorDiv.textContent = "Pilih file foto terlebih dahulu!";
        errorDiv.classList.remove('hidden');
        return;
      }

      // Ambil nama lengkap dari absensiHariIni atau userData
      let namaLengkap = "";
      // Coba ambil dari tabel users
      const { data: userData } = await supabase.from('users').select('nama_lengkap').eq('id', user.id).single();
      namaLengkap = userData && userData.nama_lengkap ? userData.nama_lengkap : "petugas";
      const namaSanitized = sanitizeNama(namaLengkap);

      // Upload ke Supabase Storage (bucket: dokumentasi)
      const fileExt = file.name.split('.').pop();
      const fileName = `${namaSanitized}_${absensiHariIni.tanggal}_${Date.now()}.${fileExt}`;
      const filePath = `${namaSanitized}/${absensiHariIni.tanggal}/${fileName}`;

      let { error: uploadError } = await supabase.storage.from('dokumentasi').upload(filePath, file, {
        cacheControl: '3600',
        upsert: false
      });

      if (uploadError) {
        errorDiv.textContent = "Gagal upload foto: " + uploadError.message;
        errorDiv.classList.remove('hidden');
        return;
      }

      // Dapatkan public URL
      const { data: urlData } = supabase.storage.from('dokumentasi').getPublicUrl(filePath);
      const fotoUrl = urlData.publicUrl;

      // Simpan ke absensi (kolom dokumentasi_url dan dokumentasi_desc)
      const { error: updateError } = await supabase.from('absensi')
        .update({
          dokumentasi_url: fotoUrl,
          dokumentasi_desc: deskripsi
        })
        .eq('id', absensiHariIni.id);

      if (updateError) {
        errorDiv.textContent = "Gagal menyimpan data dokumentasi: " + updateError.message;
        errorDiv.classList.remove('hidden');
        return;
      }

      successDiv.textContent = "Foto dokumentasi berhasil diupload!";
      successDiv.classList.remove('hidden');
      fileInput.value = "";
      document.getElementById('preview-img').src = "";
      document.getElementById('preview-img').classList.add('hidden');
      await cekAbsenHariIni();
    };

    // Tampilkan foto dokumentasi terakhir
    function tampilkanFotoDokumentasi() {
      const lastDiv = document.getElementById('last-foto');
      if (absensiHariIni && absensiHariIni.dokumentasi_url) {
        lastDiv.innerHTML = `
          <div class="mt-2">
            <div class="text-white/80 mb-1">Dokumentasi Terakhir:</div>
            <img src="${absensiHariIni.dokumentasi_url}" alt="Dokumentasi" class="rounded-lg shadow mb-2" style="max-height:120px;">
            <div class="text-white/80 text-xs">Deskripsi: ${absensiHariIni.dokumentasi_desc || '-'}</div>
          </div>
        `;
      } else {
        lastDiv.innerHTML = "";
      }
    }

    // === INISIALISASI ===
    window.onload = async function() {
      await cekLogin();
      await cekAbsenHariIni();
    };
  </script>
</body>
</html>
