<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Leaflet JS & CSS for Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #modal-map .leaflet-container { height: 300px; border-radius: 1rem; }
    .leaflet-control-attribution { display: none; }
  </style>
</head>
<body class="bg-gradient-to-br from-[#0f172a] via-[#334155] to-[#1e293b] min-h-screen flex flex-col items-center py-8">

  <!-- Header -->
  <div class="w-full max-w-6xl bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-8 border border-white/20 mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold text-white mb-1">Dashboard Admin</h1>
      <div class="text-white/80 text-sm">Monitoring Data Petugas & Absensi</div>
    </div>
  </div>

  <!-- Tabel Data Petugas -->
  <div class="w-full max-w-6xl bg-white/10 backdrop-blur-lg rounded-2xl shadow-xl p-8 border border-white/20 mb-8 overflow-x-auto">
    <h2 class="text-xl font-bold text-white mb-4">Data Petugas Hari Ini</h2>
    <table class="min-w-full text-sm text-white/90">
      <thead>
        <tr class="bg-white/10">
          <th class="px-4 py-2">Nama</th>
          <th class="px-4 py-2">Email</th>
          <th class="px-4 py-2">Status Absen</th>
          <th class="px-4 py-2">Jam Masuk</th>
          <th class="px-4 py-2">Jam Pulang</th>
          <th class="px-4 py-2">Lokasi Terakhir</th>
          <th class="px-4 py-2">Foto Dokumentasi</th>
          <th class="px-4 py-2">Aksi</th>
        </tr>
      </thead>
      <tbody id="tbody-petugas" class="divide-y divide-white/10">
        <!-- Data diisi via JS -->
      </tbody>
    </table>
    <div id="loading-petugas" class="text-white/60 text-center py-6">Memuat data...</div>
  </div>


  <!-- Modal Map Lokasi -->
  <div id="modal-map" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-md text-center relative">
      <h2 class="text-lg font-bold mb-2 text-slate-800">Lokasi Petugas</h2>
      <div id="map" class="w-full h-72 mb-4"></div>
      <button onclick="document.getElementById('modal-map').classList.add('hidden')" class="w-full py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold shadow transition-all">Tutup</button>
    </div>
  </div>

  <!-- Popup -->
  <div id="popup" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-xs text-center">
      <div id="popup-msg" class="text-slate-800 mb-4"></div>
      <button onclick="document.getElementById('popup').classList.add('hidden')" class="w-full py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold shadow transition-all">OK</button>
    </div>
  </div>

  <script>
    // === KONFIGURASI SUPABASE ===
    const SUPABASE_URL = "https://bwtwcribfhbhizlbktlo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3dHdjcmliZmhiaGl6bGJrdGxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNTQ3NDksImV4cCI6MjA2MTYzMDc0OX0.svH7YM8CORYoUfsE4YoovZMsoulWgr3xWT9X6qV39Mc";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === UTILITY ===
    function showPopup(msg) {
      document.getElementById('popup-msg').textContent = msg;
      document.getElementById('popup').classList.remove('hidden');
    }

    function formatJam(jam) {
      if (!jam) return "-";
      return jam.slice(0,5);
    }

    function statusAbsen(jamMasuk, jamPulang) {
      if (jamMasuk && jamPulang) return ["Sudah Pulang", "bg-green-400/20 text-green-400"];
      if (jamMasuk) return ["Masuk", "bg-blue-400/20 text-blue-400"];
      return ["Belum Absen", "bg-yellow-400/20 text-yellow-400"];
    }

    // === TAMPILKAN DATA PETUGAS ===
    async function loadPetugas() {
      document.getElementById('loading-petugas').classList.remove('hidden');
      const today = new Date().toISOString().slice(0,10);

      // Ambil semua user petugas
      const { data: users, error: errUsers } = await supabase.from('users').select('id, nama_lengkap, email');
      if (errUsers) {
        document.getElementById('loading-petugas').textContent = "Gagal memuat data petugas.";
        return;
      }

      // Ambil absensi hari ini
      const { data: absensi, error: errAbsensi } = await supabase
        .from('absensi')
        .select('user_id, jam_masuk, jam_pulang, lokasi_masuk, lokasi_pulang, dokumentasi_url, dokumentasi_desc')
        .eq('tanggal', today);

      const tbody = document.getElementById('tbody-petugas');
      tbody.innerHTML = "";
      users.forEach(user => {
        const absen = absensi ? absensi.find(a => a.user_id === user.id) : null;
        const jamMasuk = absen ? absen.jam_masuk : null;
        const jamPulang = absen ? absen.jam_pulang : null;
        const lokasi = absen
          ? (jamPulang ? absen.lokasi_pulang : absen.lokasi_masuk)
          : null;
        const [status, statusClass] = statusAbsen(jamMasuk, jamPulang);

        // Foto dokumentasi
        let fotoHtml = "-";
        if (absen && absen.dokumentasi_url) {
          fotoHtml = `
            <a href="${absen.dokumentasi_url}" target="_blank" title="${absen.dokumentasi_desc || ''}">
              <img src="${absen.dokumentasi_url}" alt="Dokumentasi" class="rounded shadow border border-white/20" style="max-width:60px;max-height:60px;object-fit:cover;">
            </a>
            ${absen.dokumentasi_desc ? `<div class="text-xs text-white/60 mt-1">${absen.dokumentasi_desc}</div>` : ""}
          `;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-2">${user.nama_lengkap || "-"}</td>
          <td class="px-4 py-2">${user.email}</td>
          <td class="px-4 py-2"><span class="inline-block px-3 py-1 rounded-lg font-semibold ${statusClass}">${status}</span></td>
          <td class="px-4 py-2 font-mono">${formatJam(jamMasuk)}</td>
          <td class="px-4 py-2 font-mono">${formatJam(jamPulang)}</td>
          <td class="px-4 py-2">${lokasi ? `<span class="text-xs">${lokasi}</span>` : "-"}</td>
          <td class="px-4 py-2">${fotoHtml}</td>
          <td class="px-4 py-2">
            ${lokasi ? `<button class="lihat-lokasi py-1 px-3 rounded bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold" data-lokasi="${lokasi}">Lihat Lokasi</button>` : "-"}
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('loading-petugas').classList.add('hidden');
    }

    // === MODAL MAP ===
    let map = null, marker = null;
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('lihat-lokasi')) {
        const lokasi = e.target.getAttribute('data-lokasi');
        if (!lokasi) return;
        const [lat, lng] = lokasi.split(',').map(Number);
        document.getElementById('modal-map').classList.remove('hidden');
        setTimeout(() => {
          if (!map) {
            map = L.map('map').setView([lat, lng], 17);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            marker = L.marker([lat, lng]).addTo(map);
          } else {
            map.setView([lat, lng], 17);
            marker.setLatLng([lat, lng]);
          }
        }, 200);
      }
    });
    // Reset map saat modal ditutup
    document.getElementById('modal-map').addEventListener('click', function(e) {
      if (e.target === this) this.classList.add('hidden');
    });


    // === INISIALISASI ===
    window.onload = async function() {
      await loadPetugas();
    };
  </script>
</body>
</html>
